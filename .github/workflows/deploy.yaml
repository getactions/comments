name: "Deploy to fly.io"
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Create .env.local
        run: |
          cat <<EOF > .env.local
          NEXT_PUBLIC_GISCUS_APP_HOST=${{ secrets.BASE_URL }}
          NEXT_PUBLIC_REVALIDATE_FIRST_PAGE=true
          NEXT_PUBLIC_DEMO_REPO=getactions/comments
          NEXT_PUBLIC_DEMO_REPO_ID=${{ secrets.REPO_ID }}
          NEXT_PUBLIC_DEMO_CATEGORY_ID=${{ secrets.CATEGORY_ID }}
          GITHUB_APP_ID=${{ secrets.GH_APP_ID }}
          GITHUB_CLIENT_ID=${{ secrets.GH_CLIENT_ID }}
          GITHUB_CLIENT_SECRET=${{ secrets.GH_CLIENT_SECRET }}
          GITHUB_PRIVATE_KEY="${{ secrets.GH_PRIVATE_KEY }}"
          ENCRYPTION_PASSWORD=${{ secrets.ENCRYPTION_PASSWORD }}
          ORIGINS=["${{ secrets.BASE_URL }}"]
          ORIGINS_REGEX=["http://localhost:5173"]
          EOF

      - name: Fly!
        run: |
          flyctl deploy \
            --remote-only \
            --no-cache \
            --app ${{ secrets.FLY_APP_NAME }} \
            --access-token ${{ secrets.FLY_API_TOKEN }}
